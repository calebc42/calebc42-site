{{/* Single page within a multi-page document */}}
{{ $path := printf "static/%s" (.Get "src") }}
{{ $offset := .Get "offset" | default "0" }}
{{ $pageNum := .Ordinal }}

{{/* Supernote Manta: 8mm line spacing at 300ppi */}}
{{ $lineSpacingMM := 8 }}
{{ $ppi := 300 }}
{{ $lineSpacing := div (mul $lineSpacingMM $ppi) 25.4 }}

{{ if (fileExists $path) }}
  {{ $svgContent := readFile $path }}
  
  {{/* Generate ruled lines */}}
  {{ $gridLines := "" }}
  {{ $maxLines := 30 }}
  
  {{ range seq 0 $maxLines }}
    {{ $y := add (float $offset) (mul . $lineSpacing) }}
    {{ $line := printf `<line x1="0" y1="%.2f" x2="1920" y2="%.2f" class="template-line" />` $y $y }}
    {{ $gridLines = print $gridLines $line }}
  {{ end }}

  {{/* Extract paths */}}
  {{ $innerPaths := replaceRE `(?s).*<svg[^>]*>(.*)</svg>.*` "$1" $svgContent }}
  
  {{ if not (findRE `<path` $innerPaths) }}
    {{ errorf "No paths found in SVG: %s" $path }}
  {{ end }}
  
  <div class="handwritten-page" data-page="{{ $pageNum }}">
    <div class="page-number">Page {{ $pageNum }}</div>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 2442" class="handwritten-svg">
      <defs>
        <style>
          .template-line { stroke: currentColor; opacity: 0.1; }
          .margin-line { stroke: var(--error-color, #e74c3c); opacity: 0.3; }
        </style>
        <filter id="ink-pool" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceGraphic" stdDeviation="0.5" result="blur"/>
          <feComposite in="SourceGraphic" in2="blur" operator="over"/>
        </filter>
      </defs>
      <g class="static-grid">
        {{ $gridLines | safeHTML }}
      </g>
      <g class="ink-strokes">
        {{ $innerPaths | safeHTML }}
      </g>
      <line x1="118" y1="0" x2="118" y2="2442" class="margin-line" />
    </svg>
  </div>
{{ else }}
  {{ errorf "Handwritten SVG not found: %s" $path }}
{{ end }}
